name: Build WordPress Theme

on:
  push:
    branches:
      - main
    paths:
      - 'pause-urbaine-wp-theme/**'
      - '.github/workflows/build-wordpress-theme.yml'
  pull_request:
    paths:
      - 'pause-urbaine-wp-theme/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get git SHA
        id: git-sha
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_sha=${FULL_SHA}" >> $GITHUB_OUTPUT
          echo "Git SHA: ${SHORT_SHA}"

      - name: Update version in style.css
        run: |
          cd pause-urbaine-wp-theme
          sed -i "s/Version: .*/Version: 1.0.0-${{ steps.git-sha.outputs.short_sha }}/" style.css
          echo "Updated style.css version to: 1.0.0-${{ steps.git-sha.outputs.short_sha }}"
          cd ..

      - name: Create theme archive
        run: |
          cd pause-urbaine-wp-theme
          zip -r ../pause-urbaine-theme.zip . \
            -x "*.git*" \
            -x "*.DS_Store" \
            -x "assets/scss/*" \
            -x "*.md"
          cd ..

      - name: Upload theme artifact
        uses: actions/upload-artifact@v4
        with:
          name: pause-urbaine-theme-${{ steps.git-sha.outputs.short_sha }}
          path: pause-urbaine-theme.zip
          retention-days: 90
          
      - name: Create release artifact (on main branch)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: pause-urbaine-theme-latest
          path: pause-urbaine-theme.zip
          retention-days: 365
